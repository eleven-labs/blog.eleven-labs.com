--- 
layout: post  
title: "PHP Stream : wrappers, filters... un alli√© m√©connu"   
lang: fr  
permalink: /fr/php-stream-wrappers-filters/  
excerpt: "Bien que tr√®s puissant et pr√©sent dans PHP depuis la version 4.3, ce composant est souvent m√©connu, sous-exploit√©, voire mal utilis√©."  
authors:  
    - amoutte  
categories:
    - php
    - stream 
    - flux
    - protocol  
    - wrappers
    - transports
    - filters
tags:
    - php
    - stream 
    - flux
    - protocol  
    - wrappers
    - transports
    - filters
cover: /assets/2018-05-11-php-stream-wrappers-filters/cover.jpg  
--- 

## D√©finition

La d√©finition du [manuel](http://php.net/intro.stream) √©tant d√©j√† tr√®s claire, je me contente simplement de vous la partager. 
> La gestion des flux a √©t√© introduite en PHP 4.3.0. comme m√©thode de g√©n√©ralisation des fichiers, sockets, connexions r√©seau, donn√©es compress√©es et autres op√©rations du m√™me type, qui partagent des op√©rations communes. Dans sa d√©finition la plus simple, un flux est une ressource qui pr√©sente des capacit√©s de flux. C'est-√†-dire que ces objets peuvent √™tre lus ou recevoir des √©critures de mani√®re lin√©aire, et disposent aussi de moyens d'acc√©der √† des positions arbitraires dans le flux.

## Protocoles

Un protocole est une sp√©cification de plusieurs r√®gles pour un type de communication. Il peut √©galement √™tre utile pour v√©rifier que les informations soient correctement re√ßues.

> Dans une conversation t√©l√©phonique quand l'interlocuteur d√©croche, il commence par dire "All√¥" afin de sp√©cifier qu'il est pr√™t √† recevoir des informations.

La r√©f√©rence d'un flux (style URL) s'√©crit de la forme `scheme://target`.

> Donc oui `https://blog.eleven-labs.com/` peut √™tre ouvert comme un flux qui pointe vers une ressource distante.

### Wrappers

Dans le contexte pr√©sent un `wrapper` est un gestionnaire de protocole (de style URL).

Voici la liste des `scheme` ([wrappers](http://php.net/wrappers)) support√©s par PHP :

- [file://](http://php.net/manual/fr/wrappers.file.php)  ‚Äî Acc√®s au syst√®me de fichiers local
- [http://](http://php.net/manual/fr/wrappers.http.php)  ‚Äî Acc√®s aux URLs HTTP(s)
- [ftp://](http://php.net/manual/fr/wrappers.ftp.php)  ‚Äî Acc√®s aux URLs FTP(s)
- [php://](http://php.net/manual/fr/wrappers.php.php)  ‚Äî Acc√®s aux divers flux I/O
- [data://](http://php.net/manual/fr/wrappers.data.php)  ‚Äî Donn√©es (RFC 2397)
- [glob://](http://php.net/manual/fr/wrappers.glob.php)  ‚Äî Trouve des noms de fichiers correspondant √† un masque donn√©
- [phar://](http://php.net/manual/fr/wrappers.phar.php)  ‚Äî Archive PHP (PHP >= 5.3.0)
- [zlib://](http://php.net/manual/fr/wrappers.compression.php)  ‚Äî Flux de compression **(requiert un extension pour zip://)**
- [ssh2://](http://php.net/manual/fr/wrappers.ssh2.php)  ‚Äî Shell s√©curis√© 2 **(requiert l'extension SSH2)**
- [rar://](http://php.net/manual/fr/wrappers.rar.php)  ‚Äî RAR **(requiert l'extension RAR)**
- [ogg://](http://php.net/manual/fr/wrappers.audio.php)  ‚Äî Flux Audio **(requiert l'extension OGG/Vorbis)**
- [expect://](http://php.net/manual/fr/wrappers.expect.php)  ‚Äî Flux d'interactions de processus **(requiert l'extension Expect)**

Utiliser `stream_get_wrappers()` pour avoir la liste des protocoles support√©s par votre serveur.
```php
var_dump(stream_get_wrappers());
```

### Transports

Un [transport](http://php.net/transports) en PHP ce n'est ni plus ni moins qu'un moyen de transf√©rer des donn√©es. Pour cela PHP utilise les `sockets`.

‚ÑπÔ∏è Il ne faut pas oublier que les `sockets` sont aussi des flux üòú.

**Sockets type WEB**
- tcp:// ([Transmission Control Protocol](https://fr.wikipedia.org/wiki/Transmission_Control_Protocol))
- udp:// ([User Datagram Protocol](https://fr.wikipedia.org/wiki/User_Datagram_Protocol))
- ssl:// (n√©gociation automatique entre ssl v2/v3) (sslv2://, sslv3:// depuis PHP 5.0.2) **(requiert OpenSSL)**
- tls:// **(requiert OpenSSL)**

Utiliser `stream_get_transports()` pour avoir la liste des protocoles de transport support√©s par votre serveur.
```php
var_dump(stream_get_transports());
```
> √Ä noter que les paths des `sockets` web s'√©crivent sous la forme
> `{PROTOCOL}://{DOMAIN / IP v4, v6}:{PORT}`

Voici plusieurs exemples :
-   _127.0.0.1_
-   _fe80::1_
-   _www.example.com_
-   _tcp://127.0.0.1_
-   _tcp://fe80::1_
-   _tcp://[fe80::1]:80_
-   _tcp://www.example.com_
-   _udp://www.example.com_
-   _ssl://www.example.com_
-   _sslv2://www.example.com_
-   _sslv3://www.example.com_
-   _tls://www.example.com_

**Sockets type UNIX**
- unix:// (fournit l'acc√®s √† un flux de type socket, sur un domaine Unix)
- udg:// (fournit un mode de transport alternatif, avec un protocole de datagrammes utilisateur)

----

Voila un petit tour d'horizon des diff√©rents protocoles que PHP met nativement, ou par extensions, √† votre disposition.

**üë®‚ÄçüöÄ Il est √©galement possible de cr√©er sont propre `wrapper`, afin d'encapsuler la logique de transmission des donn√©es !**

Comme par exemple :

- [s3://](https://docs.aws.amazon.com/aws-sdk-php/v2/guide/feature-s3-stream-wrapper.html) donne acc√®s √† votre storage AWS
- [git://](https://github.com/teqneers/PHP-Stream-Wrapper-for-Git#using-the-streamwrapper) permet d'int√©ragir avec git
- [hoa://](https://github.com/hoaproject/Protocol) permet d'acc√©der aux diff√©rentes informations manag√©es par HOA

### Contexte de flux

Les contextes de flux sont une autre notion importante de la gestion des flux. Le contexte est un ensemble d'options qui sera pass√© en argument aux diverses fonctions de traitements de flux (ex: `stream_*`, `fopen`, `copy`, `file_get_contents`...).

```php
$context = stream_context_create(
    [
        'http' => [
            'protocol_version' => '1.1', 
            'timeout' => 10, 
            'user_agent' => 'Wilson Browser', 
            'method' => 'GET',
        ],
    ],
    []
);

$result = file_get_contents('http://../page', false, $context);
```
> La requ√™te g√©n√©r√©e pour r√©cup√©rer la page sera donc en `GET HTTP 1.1` avec un user agent `Wilson Browser` et un timeout √† 10 secondes.

Vous pouvez √©galement utiliser `stream_context_set_default` afin de configurer les options par d√©faut des gestionnaires de flux.

```php
stream_context_set_default([
    'http' => [
        'timeout' => 10, 
        'user_agent' => 'Wilson Browser',
    ],
    'ftp' => [...]
]);
```
> ‚ö†Ô∏è Attention √† l'utilisation de cette derni√®re, car elle configure les options de toutes les requ√™tes HTTP faites par la couche de flux de PHP.

### Filtres

Une autre partie assez int√©ressante des flux √©tant la possibilit√© d'ajouter des fonctions de [filtre](http://php.net/filters) sur les donn√©es qui transiteront dans le flux.

- _string.rot13_
- _string.toupper_
- _string.tolower_
- _string.strip_tags_ **(depuis PHP 5)**
- _convert.base64-encode_ - _convert.base64-decode_
- _convert.quoted-printable-encode_ - _convert.quoted-printable-decode_
- _zlib.deflate_ (compression) (PHP >= _5_ si le support [zlib](http://php.net/manual/fr/ref.zlib.php) est activ√©)
- _zlib.inflate_ (decompression) (PHP >= _5_ si le support [zlib](http://php.net/manual/fr/ref.zlib.php) est activ√©)
- _bzip2.compress (PHP >= _5_ si le support [bz2](http://php.net/manual/fr/ref.bzip2.php) est activ√©)
- _bzip2.decompress_ (PHP >= _5_ si le support [bz2](http://php.net/manual/fr/ref.bzip2.php) est activ√©)
- _mcrypt.*_ (‚ùå **_OBSOLETE_ depuis PHP 7.1.0. Nous vous encourageons vivement √† ne plus l'utiliser.**)
- _mdecrypt.*_ (‚ùå **_OBSOLETE_ depuis PHP 7.1.0. Nous vous encourageons vivement √† ne plus l'utiliser.**)

Utiliser `stream_get_filters()` pour avoir la liste des filtres support√©s par votre serveur.
```php
var_dump(stream_get_filters());
```

Il existe 2 syntaxes pour configurer un filtre sur un flux.

L'utilisation de `stream_filter_append`/`stream_filter_prepend`.
```php
$fp = fopen('php://output', 'w');
stream_filter_append($fp, 'string.toupper', STREAM_FILTER_WRITE);
fwrite($fp, "Code de lancement: 151215");
fclose($fp);
```
[`Ex√©cuter le php`](https://3v4l.org/VV6FG)

Gr√¢ce au flux `php://filter`
```php
file_put_contents('php://filter/string.toupper/resource=php://output', 'Code de lancement: 151215');
```
[`Ex√©cuter le php`](https://3v4l.org/4nggb)
> Les 2 exemples ci-dessus vont afficher `CODE DE LANCEMENT: 151215`

**üë®‚ÄçüöÄ L√† aussi il est possible de cr√©er son propre `filter` gr√¢ce √† [php_user_filter](http://php.net/php_user_filter) !**

Voici un petit filtre geek.

```php
class l33t_filter extends php_user_filter {  
    function filter($in, $out, &$consumed, $closing)  
    {
        $common = ["a", "e", "s", "S", "A", "o", "O", "t", "l", "ph", "y", "H", "W", "M", "D", "V", "x"];
        $leet = ["4", "3", "z", "Z", "4", "0", "0", "+", "1", "f", "j", "|-|", "\\/\\/", "|\\/|", "|)", "\\/", "><"];  
  
        while ($bucket = stream_bucket_make_writeable($in)) {  
            $bucket->data = str_replace($common, $leet, $bucket->data);  
            $consumed += $bucket->datalen;  
            stream_bucket_append($out, $bucket);  
        }  
        return PSFS_PASS_ON;  
    }
}
stream_filter_register('l33t_filter', 'l33t_filter') or die('Failed to register filter Markdown');

file_put_contents('php://filter/l33t_filter/resource=php://output', 'Salut √ßa va?');
```
[`Ex√©cuter le php`](https://3v4l.org/Zpgr8)

> L'exemple du dessus convertira `Salut √ßa va?` en `Z41u+ √ß4 v4?`

On peut imaginer des filtres html>markdown,  un emoji converter, un dictionnaire de mots blacklist√©s, etc.

## Les flux I/O

PHP met √©galement √† notre disposition des flux d'`Input`/`Output`. 

### php://stdin 
C'est le flux d'entr√©e standard (ligne de commande)
> ‚ÑπÔ∏è stdin: est en lecture seule

Exemple
```php
//index.php
copy(  
    'php://stdin',  
    'php://filter/string.toupper/resource=php://stdout'
);
```
La commande ci-dessous √©crira `string` dans le flux `stdin` et ici on copie simplement ce que l'on re√ßoit dans la sortie standard apr√®s avoir appliqu√© un filtre `toupper`.
```bash
$ echo 'string' | php index.php #affichera STRING
$ cat file.txt | php index.php #affichera le contenu du fichier en majuscule
```

### php://stdout et php://stderr
Sont les flux de sortie standards (ligne de commande)
> ‚ÑπÔ∏è stdin: est en lecture seule

Exemple
```php
//error.php
error_reporting(E_ALL);
ini_set("display_errors", 0);  
echo 'Hello '.$_GET['user'];
```
Avec ce script nous allons reporter toutes les erreurs (E_ALL) mais ne pas les afficher aux visiteurs.

Dans un navigateur web ce script affichera :
```
Hello
```
Et les erreurs seront dirig√©es vers le flux `php://stderr` qui est bien souvent configur√© par votre file handler (nginx/apache...) gr√¢ce au param√®tre [error_log](http://php.net/error-log).

üë®‚ÄçüöÄ **En ligne de commande `php://output` `php://stderr` sont par d√©faut envoy√©s dans `php://stdout`**

Lan√ßons ce script avec la commande suivante :
```bash
$ php error.php
```
Ce qui donnera :
```
PHP Notice:  Undefined index: user in /var/www/error.php on line 5
PHP Stack trace:
PHP   1. {main}() /var/www/error.php:0
Hello %
```
**Utilisons maintenant la redirection de flux GNU/Linux**
```bash
$ php error.php > out.txt
```
la console affichera :
```
PHP Notice:  Undefined index: user in /var/www/error.php on line 5
PHP Stack trace:
PHP   1. {main}() /var/www/error.php:0
```
tandis que le fichier `out.txt` contiendra :
```
Hello
```

**Mais on peut √©galement rediriger la sortie d'erreur**
```bash
$ php error.php 2> errors.txt
```
la console affichera :

```
Hello
```
tandis que le fichier `errors.txt` contiendra :
```
PHP Notice:  Undefined index: user in /var/www/error.php on line 5
PHP Stack trace:
PHP   1. {main}() /var/www/error.php:0
```
‚ÑπÔ∏è On peut √©galement combiner les 2 `php error.php > out.txt 2> errors.txt`
> `>` et `2>` √©crase le fichier ou le cr√©e.
> `>>` et `2>>` √©crit √† la fin du fichier ou le cr√©e.
> `2>&1` et `2>>&1` redirige les 2 flux (avec le m√™me comportement pour `>` et `>>`)

### php://input
Permet de lire les donn√©es brutes du corps de la requ√™te.
> ‚ö†Ô∏è N'est pas disponible avec _enctype="multipart/form-data"_.

### php://output
Permet d'√©crire dans le buffer de sortie de la m√™me fa√ßon que `print` `echo`.
```php
// les 2 √©critures suivantes feront la m√™me chose
file_put_contents('php://output', 'Some data');
echo 'Some data';
```
N'oubliez pas qu'avec `php://output` vous pouvez utiliser les filtres, le contexte et m√™me pourquoi pas r√©√©crire au d√©but.

### php://temp et php://memory
Permet d'√©crire dans un gestionnaire de fichiers. `php://memory` stockera toujours en m√©moire tandis que `php://temp` stockera en m√©moire, puis sur disque apr√®s avoir attendu la limite pr√©d√©finie (d√©faut 2Mo)
> üë®‚ÄçüöÄ `php://temp/maxmemory:200` stockera sur disque une fois que 200 octets seront √©crit dans le flux.

### php://filter
Permet d'ajouter un filtre lors de l'ouverture d'un autre flux.
Exemple :
```php
// Applique un filtre lors de la lecture
file_get_contents('php://filter/read=string.rot13/resource=example.txt');

// Applique un filtre lors de l'√©criture
file_put_contents('php://filter/write=string.rot13/resource=example.txt', 'new data');

// Applique le filtre lors de l'√©criture mais aussi lors de la lecture
$res = fopen('php://filter/string.rot13/resource=example.txt', 'w+');
```

### php://fd

N'ayant pas trouv√© d'informations utiles je vous laisse consulter la [documentation](http://php.net/wrappers-php#refsect2-wrappers.php-unknown-unknown-unknown-unknown-descriptior)

## Quelques cas d'utilisation

Prenons l'exemple d'une copie de fichier :
```php
$file = file_get_contents('http://.../textfile.txt');
file_put_contents(__DIR__.'/downloaded_textfile.txt', $file);
```
‚ö†Ô∏è Avec ce code nous allons t√©l√©charger **enti√®rement** le fichier `textfile.txt` dans la m√©moire avant de l'√©crire dans le fichier de destination !

Maintenant si l'on change l√©g√®rement le code on obtient :

DO
```php
copy(
    'http://.../textfile.txt', 
    __DIR__.'/downloaded_textfile.txt'
);
```
‚ÑπÔ∏è On peut faire le m√™me traitement avec des ressources :

```php
stream_copy_to_stream(
    fopen('http://.../textfile.txt', 'r'), 
    fopen(__DIR__.'/downloaded_textfile.txt', 'w+')
);
```
Voici la consommation m√©moire pour un fichier de 5Mo.

| Code  | memory_get_usage(true) | memory_get_peak_usage(true) |
|--|--|--|
| file_get_content | 8Mo | 13Mo |
| copy | 2Mo | 2Mo |
|stream_copy_to_stream|2Mo|2Mo|

La diff√©rence de consommation m√©moire est due au fait que `copy` et `stream_copy_to_stream` vont directement √©crire la source dans la destination.

üë®‚ÄçüöÄ N'h√©sitez pas √† utiliser les `wrappers`/`transports` cit√©s au d√©but de l'article.

---
```php
copy(
    'http://.../image.jpg', 
    'ssh2.scp://user:pass@server:22/home/download/image.jpg'
);
```
> Copie le fichier depuis le web sur un serveur en utilisant `scp` via `ssh`.

---

Un autre exemple fr√©quemment rencontr√© lors de la cr√©ation de fichier temporaire :

```php
$tmpFile = tempnam(sys_get_temp_dir(), 'php' . rand());
```
‚ö†Ô∏è Ici le script va cr√©er un **fichier** dans le **dossier temporaire** de php. 
- Ce qui veut dire qu'il vous faudra supprimer vous-m√™me ce fichier.
- La fonction `tempnam()` retourne le `path` et non la ressource.

üë®‚ÄçüöÄ Pr√©f√©rez donc l'utilisation de :
- `php://temp` ou `php://temp/maxmemory:100` qui stockera en m√©moire puis sur disque une fois la limite atteinte.
- `php://memory` stocker en m√©moire
- `tmpfile()` cr√©e un fichier temporaire avec un nom unique, ouvert en √©criture et lecture (_w+_), et retourne un pointeur de fichier.

```php
$tmp = fopen('php://temp', 'w+');
```

Ce fichier sera automatiquement effac√© :
- lorsqu'il sera ferm√©.
- lorsqu'il n'y a plus de r√©f√©rence au gestionnaire de fichiers.
- lorsque le script sera termin√©.

## Conclusion
Bien que tr√®s puissant et pr√©sent dans PHP depuis la version 4.3, ce composant est souvent m√©connu, sous exploit√©, voire mal utilis√©. C'est pourquoi j'en fais la promotion ici. J'esp√®re avoir suscit√© votre int√©r√™t !

üìù **Je n'ai volontairement pas abord√© les flux de type `socket` car, ils m√©riteraient un article √† eux seuls.**

## Liens utiles
- üëç https://www.youtube.com/watch?v=3tOGhPj8IcA
- http://php.net/stream
- http://php.net/context
- http://php.net/wrappers
- https://github.com/reactphp/react
