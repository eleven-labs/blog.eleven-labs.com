---
layout: post
title: 'k9s - Une IHM Kubernetes dans son terminal'
excerpt: Pr√©sentation didactique d'un outil graphique d'administration et de monitoring de cluster Kubernetes depuis son terminal.
lang: fr
authors:
    - dfert
permalink: /fr/k9s/
categories:
    - agile
tags:
    - devops
    - kubernetes

image:
  path: /assets/2021-02-10-k9s/k9s.png
  height: 904
  width: 700

---

![Logo k9s]({{ site.baseurl }}/assets/2021-02-10-k9s/k9s.png)

Dans ce billet de blog je vous propose de d√©couvrir [k9s](https://k9scli.io/), un outil graphique en ligne de commande pour *Kubernetes* qui peut faciliter la gestion des ressources d'un cluster, donner pas mal de visibilit√© sur son √©tat g√©n√©ral, et acc√©l√©rer vos op√©rations courantes.

En quelques mots, *k9s* propose diff√©rentes *vues* et raccourcis adapt√©s √† chaque type de ressources. Ce m√©canisme permet de facilement acc√©der aux logs d'un pod, d'attacher un shell √† un conteneur, d'activer un port-fowarding, d'agrandir un replicaset, etc.
 
Croyez moi, c'est super pratique, mais la b√™te n'est pas si simple √† dompter et c'est justement pour aider √† sa prise en main que j'ai eu envie d'√©crire ce billet aujourd'hui.

## Installation
*k9s* est un projet √©crit en *Go* et publi√© en tant que binaire ex√©cutable. Pour l'installer, r√©cup√©rez une version depuis le [Github du projet](https://github.com/derailed/k9s#installation) et placez la dans le dossier de votre choix (`/usr/bin/` par exemple). Assurez-vous que ce dossier est bien r√©f√©renc√© dans votre `PATH`.

Pour interagir avec un cluster, *k9s* lit les informations du fichier `~/.kube/config`. Si vous n'avez pas de cluster sous la main, je vous invite √† en installer un localement avec des outils tels que [kind](https://github.com/kubernetes-sigs/kind) ou [minikube](https://github.com/kubernetes-sigs/kind) et √† y cr√©er quelques ressources.  Sinon, il vous suffit de lancer `k9s` depuis votre terminal et ce dernier utilisera automatiquement votre contexte Kubernetes courant. Vous pouvez √©galement sp√©cifier le contexte et le namespace via les commandes respectives suivantes `k9s --context <context>` et `k9s -n <namespace>` (nous verrons comment changer de contexte et de namespace dans k9s √† la fin de ce billet).

Enfin, vous pouvez lancer k9s en lecture seule avec l'argument `--readonly`. La liste compl√®te des arguments est disponible dans l'aide `k9s help`.

## Pr√©sentation de l'interface
Voici maintenant un aper√ßu de l'interface de k9s qui en r√©sume les principales zones d'int√©r√™t :

![Main k9s]({{ site.baseurl }}/assets/2021-02-10-k9s/k9s_main.png)

- En haut √† gauche, quelques informations globales donn√©es par *k9s* telles que le nom du cluster auquel vous √™tes connect√©, le contexte actuellement utilis√©, votre userid, votre version de k9s, etc.
- Juste √† droite, vous trouverez une liste de raccourcis utiles pour interagir avec k9s. Gardez dans un coin de votre t√™te que son contenu change en fonction de la vue active, nous y reviendrons plus tard. Notez aussi que la touche `?` ouvrira l'aide compl√®te √† tout moment.
- Au milieu, on retrouve le panneau principal, c'est ici que se trouveront toutes les informations sur nos ressources. Son contenu changera lui aussi en fonction de la vue active et le nom de cette derni√®re vous sera rappel√© dans le titre du panneau principal. 
- Enfin tout en bas √† gauche, un *fil d'Ariane* (ou *breadcrumbs*) nous donne la hi√©rarchie de la vue active et indique vers quelle vue nous retournons lorsqu'on la quitte.

D'une mani√®re g√©n√©rale, k9s reprend plusieurs principes de `vim`. La touche `esc` sert √† revenir en arri√®re ou √† annuler / fermer un prompt et on quitte le programme avec `:q` (ou `ctrl + c`).

Lorsque vous serez parfaitement √† l'aise avec *k9s*, vous pourrez masquer le panneau principal en pressant `ctrl + e` afin d'√©conomiser un peu de place, mais pour l'instant je vous invite √† le laisser affich√©.

## Les diff√©rents modes

### Le mode commande
La touche `:` ouvre un prompt chien (`üê∂>`) au-dessus du panneau principal. C'est le mode de *k9s* qui permet d'ex√©cuter des commandes. Il existe une commande par ressource kubernetes plus quelques autres sp√©cifiques que nous verrons plus tard. Par exemple, `:pod‚èé` bascule dans la vue *Pod* et ce sont d√©sormais les informations sur les pods qui sont affich√©es dans le panneau principal.

![Le prompt du mode commande]({{ site.baseurl }}/assets/2021-02-10-k9s/gif_dog_prompt.gif){: .center-image .no-link-style}

*k9s* fait de l'autosuggestion pour le nom des commandes. Quand je tappe `pod`, il me propose la commande `poddisruptionbudget`. 
- Les touches üîº et üîΩ permettent de naviguer circulairement entre les diff√©rentes propositions
- Les touches ‚û° , `tab` ou `ctrl + f` permettent de compl√©ter automatiquement la suggestion dans le prompt (autocompl√©tion), sans toutefois ex√©cuter la commande
- Les touches `ctrl + u` ou `ctrl + w` permettent d'effacer la ligne sans quitter le mode commande

![Autosuggestion du mode commande]({{ site.baseurl }}/assets/2021-02-10-k9s/gif_autosuggest.gif){: .center-image .no-link-style}

Pratique non ?

La liste compl√®te des commandes est disponible par le raccourci `ctrl + a` ou avec `:aliases`.

![Commande Aliases]({{ site.baseurl }}/assets/2021-02-10-k9s/ctrl_a.png){: .center-image .no-link-style}

On notera que toutes les commandes disposent d'un alias plus court qui permet d'acc√©l√©rer la navigation (e.g. `:a` au lieu de `:aliases`)

Si vous entrez une commande qui n'existe pas k9s vous le fera savoir avec une *cowsay* qui malheureusement ne partira pas avec la touche `esc`. Pour  sortir de cette vue, il faut rejouer une commande valide comme `:pod‚èé` par exemple.

![Erreur cowsay]({{ site.baseurl }}/assets/2021-02-10-k9s/gif_cowsay.gif){: .center-image .no-link-style}

Voil√†, vous savez d√©sormais ex√©cuter diff√©rentes commandes qui vous permettent de changer de vues. C'est d√©j√† pas mal ! Vous √™tes capables de lister les diff√©rentes ressources de votre cluster et de voir si elles sont OK ! Allons un peu plus loin maintenant.

### Le mode filtre
La touche `/` ouvre un prompt caniche `üê©>` qui permet d'appliquer un filtre sur la liste d'√©l√©ments affich√©s dans le panneau. C'est le mode filtre de k9s.

En reprenant notre exemple, si l'on est dans la vue pod (`:pod`) et que l'on tape `/kops‚èé` on n'affichera que les *Pods* qui contiennent `kops` dans leur nom. Ce prompt supporte `Regex2` et on peut utiliser des syntaxes comme `/toto|astronaute‚èé` (`toto` ou `astronaute` dans le nom du pod) ou `!tata` (tous les noms de pods qui ne contiennent pas `tata`).

![Filtre sur le nom]({{ site.baseurl }}/assets/2021-02-10-k9s/gif_caniche_kops.gif){: .center-image .no-link-style}

On peut aussi filtrer les ressources qui portent un label kubernetes avec la syntaxe `/-l <nom_du_label>=<valeur_du_label>`. Dans notre exemple `/-l k8s-app=cilium` liste tous les pods qui portent le label `k8s-app=cilium` (notez bien qu'on filtre uniquement sur l'existence de label ici et pas sur le nom des pods.)

![Filtre sur les labels]({{ site.baseurl }}/assets/2021-02-10-k9s/gif_label_search.gif){: .center-image .no-link-style}

Ce prompt fonctionne dans *toutes* les vues de *k9s* et applique le filtre sur tout ce qui est affich√© dans le panneau principal. Il n'est pas r√©serv√© aux vues des ressources Kubernetes. Voyez un exemple dans la vue `aliases`.

![Mode filtre dans la vue Aliases]({{ site.baseurl }}/assets/2021-02-10-k9s/gif_caniche_alias.gif){: .center-image .no-link-style}

Voil√†, d√©sormais vous savez comment retrouver toutes vos petites ressources. On va pouvoir d√©couvrir maintenant comment interagir avec elles. 


## Le panneau des raccourcis
Int√©ressons-nous de plus pr√®s au panneau des raccourcis. Il contient tout ce qu'il vous faut pour vos op√©rations courantes. Rappelez-vous que son contenu change en fonction de la vue dans laquelle vous √™tes, alors pensez √† vous y r√©f√©rer r√©guli√®rement üí°. Voici par exemple le contenu des raccourcis pour la vue pod :

![Raccourcis vue pod]({{ site.baseurl }}/assets/2021-02-10-k9s/raccourcis_vue_pod.png){: .center-image .no-link-style}

Vous pouvez √† tout moment appuyer sur la touche `?` pour afficher l'aide compl√®te.

![Aide compl√®te]({{ site.baseurl }}/assets/2021-02-10-k9s/full_help.png){: .center-image .no-link-style}

Globalement, un raccourci s'applique √† la ligne du panneau principal en surbrillance et vous pouvez changer de ligne en utilisant les fl√®ches de votre clavier.

![Selection de ligne]({{ site.baseurl }}/assets/2021-02-10-k9s/gif_select_lines.gif){: .center-image .no-link-style}

Les touches num√©riques affich√©es en magenta dans le panneau des raccourcis permettent de filtrer le contenu du panneau principal sur la base d'un param√®tre qui change d'une vue √† l'autre. Pour les pods par exemple, ces touches changent le namespace, mais pour les logs elles changent la plage temporelle √† afficher. La valeur du param√®tre est rappel√©e en magenta dans le titre du panneau principal

![Changement de namespace vue pod touche num√©rique]({{ site.baseurl }}/assets/2021-02-10-k9s/gif_numeric_parameter.gif){: .center-image .no-link-style}

Dans l'exemple ci-dessus, mon √©cran se vide lorsque je s√©lectionne le namespace *default* (`<2>`) car je n'ai pas de pod sur ce namespace. Pensez donc √† v√©rifier r√©guli√®rement la valeur de ces param√®tres.

Vous avez maintenant toutes les billes pour commencer √† faire des op√©rations sur vos ressources. Voici celles que j'utilise le plus fr√©quemment.

---

## Op√©rations courantes

### Changer de contexte ou de namespace
Pour changer de contexte au sein de *k9s*, il suffit de taper `:ctx <context>‚èé`. De m√™me, pour changer de namespace vous pouvez utiliser `:ns <namespace>‚èé`

### Afficher des informations des ressources associ√©es
Dans une vue de ressource, la touche `‚èé` permet d'afficher des informations sur les √©l√©ments associ√©s √† cette ressource. Depuis la vue `:pod` par exemple, appuyer sur `‚èé` affiche des informations sur les conteneurs du pod, et dans la vue `:service` on obtient des informations sur les pods associ√©s au service.

### Afficher les valeurs non chiffr√©es d'un secret Kubernetes
Depuis la vue `:secrets` appuyer sur `x` permet d'afficher toutes les valeurs du secret en clair.

### Trier les ressources par colonne
Dans les diff√©rentes vue de ressources, on peut trier les √©l√©ments par colonnes. Dans la vue `:pod` par exemple on peut utiliser les raccourcis suivants : 

- `Shift + p` ‚Äî tri par namespace
- `Shift + n` ‚Äî tri par nom
- `Shift + r` ‚Äî tri par nombre de conteneur *ready*
- `Shift + t` ‚Äî tri par nombre de red√©marrage
- `Shift + s` ‚Äî tri par status
- `Shift + c` ‚Äî tri par consommation CPU
- `Shift + m` ‚Äî tri par consommation RAM
- `Shift + i` ‚Äî tri par adresse IP
- `Shift + o` ‚Äî tri par adresse du noeud
- `Shift + a` ‚Äî tri par age

Une petite fl√®che bleue se placera √† cot√© de la colonne et indiquera le sens du tri. Appuyer plusieurs fois sur un m√™me raccourci inverse l'ordre du tri.

![Changement ordre tri]({{ site.baseurl }}/assets/2021-02-10-k9s/gif_sort_name.gif){: .center-image .no-link-style}  

Les raccourcis de tri changent d'une vue √† l'autre et la liste compl√®te est donn√©e dans l'aide (touche `?`)

### Afficher des logs
Dans la vue `:pod`, la touche `l` permet d'afficher des logs du pod s√©lectionn√©. Lorsque qu'un pod n'√©crit pas beaucoup de logs, on est g√©n√©ralement confront√© au message `Waiting for logs...`. 

![Message waiting for logs]({{ site.baseurl }}/assets/2021-02-10-k9s/gif_waiting_for_logs.gif){: .center-image .no-link-style}

Cette vue n'affiche en effet que les logs avec un timestamp vieux de maximum 1 minute et quand il n'y en a pas, elle attend alors qu'un log assez jeune arrive. Si vous cherchez des logs plus vieux, vous pouvez changer la plage temporelle avec les touches `0` √† `5`. La dur√©e s√©lectionn√©e est rappel√©e dans le titre du panneau principal repr√©sent√© par la fl√®che rouge dans l'image ci-dessous.
	
![Menu log dur√©e 1m]({{ site.baseurl }}/assets/2021-02-10-k9s/k9s_log_waiting.png){: .center-image .no-link-style}

On peut naviguer dans les logs √† l'aide des fl√®ches ‚áû et ‚áü, toutefois, l'autoscroll est activ√© par d√©faut et forcera l'affichage vers le bas d√®s qu'un nouveau log arrivera. On peut activer / d√©sactiver cette fonction avec la touche `s`. Aussi, on peut afficher / masquer l'affichage des *timestamps* avec la touche `t` 

N'oubliez pas √©galement que `üê©>` fonctionne ici √©galement.

![Menu filtre dans les logs]({{ site.baseurl }}/assets/2021-02-10-k9s/gif_caniche_logs.gif){: .center-image .no-link-style}

### Ouvrir un shell dans un conteneur
Dans la vue `:pod`, la touche `s` permet d'attacher un shell √† un conteneur s'ex√©cutant au sein d'un pod. Si le pod contient plusieurs conteneurs, un prompt demandera de s√©lectionner celui auquel on souhaite attacher un shell.

Une fois le shell attach√©, on peut le d√©connecter en pressant `ctrl + d`.

![Shell conteneur]({{ site.baseurl }}/assets/2021-02-10-k9s/gif_shell.gif){: .center-image .no-link-style}

### Upscale / Downscale des ressources
Dans la vue `:statefulset` ou `:replicaset`, on peut modifier le nombre de r√©plica en appuyant sur la touche `s`.

![Scaling replica]({{ site.baseurl }}/assets/2021-02-10-k9s/k9s_scale_replicas.png){: .center-image .no-link-style}

### Retrouver qui utilise une ressource
Certaines vues permettent de lister les ressources qui sont consomm√©es par d'autres ressources en utilisant la touche `u` (*used by*). Cela fonctionne pour la vue `:secrets` ou `:configmap` par exemple.

### D√©truire une ressource
`ctrl + d` permet de d√©truire une ressource. L'option `cascade`, activ√©e par d√©faut, permet de supprimer en plus les ressources qui lui sont associ√©es. D√©truire un d√©ploiement en mode cascade d√©truira √©galement les pods associ√©s √† ce d√©ploiement.

![D√©truire pod]({{ site.baseurl }}/assets/2021-02-10-k9s/k9s_delete_pod.png){: .center-image .no-link-style}

Il est aussi possible de faire un *kill* avec `ctrl +k` pour les pods, mais faites attention, cette op√©ration ne demande pas de confirmation ! üí£

### D√©crire / √©diter une ressource
Il est parfois int√©ressant de lire la description d'une ressource pour v√©rifier sa liste de labels par exemple. Pour cela on peut soit utiliser la touche `d` qui retourne la description format√©e par *k9s*, soit la touche `y` pour obtenir le fichier *YAML* brut. Dans ces vues, lorsque l'on utilise le mode filtre et qu'il correspond √† plusieurs r√©sultats, on pourra naviguer vers l'occurence suivante avec la touche `n` et l'occurence pr√©c√©dente avec `shift+n` (pensez bien √† valider le filtre avec `‚èé` avant d'appuyer sur ces touches).

![Navigation mode filtre]({{ site.baseurl }}/assets/2021-02-10-k9s/gif_describe_next_match.gif){: .center-image .no-link-style}

Il est √©galement possible d'√©diter le ficher YAML correspondant √† une ressource en appuyant avec `e`. Cela ouvrira votre √©diteur de texte par d√©faut et appliquera les modifications une fois le fichier sauvegard√©. 

### Actions group√©es
On peut "marquer" des ressources pour leur appliquer une action commune (e.g. supprimer 2 pods d'un coup). On marque la ressource en surbrillance en appuyant sur `espace`. La ressource change alors de couleur et on appuiera de nouveau sur `espace` pour retirer la marque.

![Marquer une ressource]({{ site.baseurl }}/assets/2021-02-10-k9s/gif_basic_markers.gif){: .center-image .no-link-style}

On peut √©galement marquer une plage de ressource. Pour cela :

- Mettre en surbrillance la premi√®re ressource de la plage 
- Marquer la ressource avec `espace`
- Avec les fl√®ches, selectionner la derni√®re ressource de la plage
- Appuyer sur `ctrl+espace`. 

Toutes les ressources de la plage sont maintenant marqu√©es. On peut effacer toutes les marques d'un coup avec `ctrl+\`.

![Marquer une plage de ressources]({{ site.baseurl }}/assets/2021-02-10-k9s/gif_marker_range.gif){: .center-image .no-link-style}

D√®s que l'on pose une marque, les actions qui peuvent s'appliquer √† un groupe de ressources s'appliqueront aux ressources marqu√©es et non pas √† la ligne en surbrillance. Dans l'exemple ci-dessous mon action *killed* (`ctrl+k`) s'applique √† tous les ressources marqu√©es et pas √† la ressources en surbrillance.

![Effacer tous les marqueurs]({{ site.baseurl }}/assets/2021-02-10-k9s/gif_marker_delete.gif){: .center-image .no-link-style}

---

## Vues sp√©ciales

### Pulses

**Pulses** est un dashboard global qui permet de voir l'√©tat de sant√© de votre cluster. Il affiche le nombre de ressources OK / KO au cours du temps et permet via les touches num√©riques ou tab de passer rapidement dans la vue la plus pertinente pour surveiller un param√®tre. On active sa vue avec `:pulses`

![Vue Pulses]({{ site.baseurl }}/assets/2021-02-10-k9s/pulses.png){: .center-image .no-link-style}

### Xray
**Xray** est un outil qui permet de visualiser sour forme d'arborescence les d√©pendances entre les ressources. On active cette vue avec `:xray <ressource>`. En utilisant `pod` par exemple, Xray donne l'arbre de d√©pendance des pods par namespaces (leurs conteneurs, configmaps, tokens, etc.) C'est tr√®s pratique pour retrouver ses petits quand on commence √† avoir un cluster assez gros.

![Vue Xray]({{ site.baseurl }}/assets/2021-02-10-k9s/xray_pods.png){: .center-image .no-link-style}

Dans cet exemple, mes pods sont r√©partis sur 5 namespaces diff√©rents (üóÇ), le namespace `pplogs` contient 32 pods (üöõ), le pod `elastic-client-6d7cdcd4fd-nrmtc` contient 5 types de ressources diff√©rentes : 

- 1 service account (üí≥)
- 1 secret (üîí)
- 1 configmap (üó∫)
- 2 conteneurs (üê≥)

![Gif Xray]({{ site.baseurl }}/assets/2021-02-10-k9s/gif_xray.gif){: .center-image .no-link-style}

### Popeye
**Popeye** est un outil qui permet de tester la conformit√© des ressources d'un cluster selon diff√©rents crit√®res. Chaque type de ressources se voit attribu√© un score de conformit√© et la navigation permet d'acc√©der aux diff√©rentes erreurs et warnings rencontr√©s.

![Animation Popeye]({{ site.baseurl }}/assets/2021-02-10-k9s/gif_popeye.gif){: .center-image .no-link-style}

---

## Customisation

Je ne d√©taillerai pas cette partie dans ce billet mais sachez qu'il est possible de d√©finir un fichier de configuration k9s et √©galement de personnaliser diff√©rents aspects tel que son skin, ses plugins et des alias suppl√©mentaires. Vous trouverez plus d'informations dans la documentation du projet.

---

## Conclusion
Voila c'est tout pour cette fois ! J'esp√®re vous avoir convaincu de la puissance de *k9s* et qu'il trouvera une place dans votre bo√Æte √† outil galactique. Malgr√© sa prise en main un peu exigeante, son utilisation ne devrait plus trop avoir de secret pour vous et je reste convaincu que l'investissement en vaut la chandelle. De mon c√¥t√©, je ne peux plus m'en passer.

N'h√©sitez pas √† me faire part de vos r√©actions dans les commentaires. üöÄ *To infinity and beyond!* üöÄ

## Cr√©dits
J'ai utilis√© les logiciels [Sublime Text 3](https://www.sublimetext.com/3) pour la r√©daction de cet article ; [Peek](https://github.com/phw/peek), [Screenkey](https://www.thregr.org/~wavexx/software/screenkey/) et [Key-Mon](https://github.com/scottkirkwood/key-mon) pour r√©aliser mes gifs. Un grand merci aux d√©veloppeurs de ces projets.
